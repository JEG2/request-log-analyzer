<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: RequestLogAnalyzer::LogProcessor</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">RequestLogAnalyzer::LogProcessor</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/request_log_analyzer/log_processor_rb.html">
                lib/request_log_analyzer/log_processor.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
The Logprocessor class is used to perform simple processing actions over
log files. It will go over the log file/stream line by line, pass the line
to a processor and write the result back to the output file or stream. The
processor can alter the contents of the line, remain it intact or remove it
altogether, based on the current file format
</p>
<p>
Currently, two processors are supported, :strip and :anonymize.
</p>
<pre>
 * :strip will remove all irrelevent lines (according to the file format) from the
   sources. A compact, information packed log will remain/.
 * :anonymize will anonymize sensitive information from the lines according to the
   anonymization rules in the file format. The result can be passed to third parties
   without privacy concerns.
</pre>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000158">anonymize_line</a>&nbsp;&nbsp;
      <a href="#M000153">build</a>&nbsp;&nbsp;
      <a href="#M000154">new</a>&nbsp;&nbsp;
      <a href="#M000155">process_file</a>&nbsp;&nbsp;
      <a href="#M000156">process_io</a>&nbsp;&nbsp;
      <a href="#M000159">run!</a>&nbsp;&nbsp;
      <a href="#M000157">strip_line</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="FileFormat/Awareness.html">RequestLogAnalyzer::FileFormat::Awareness</a></span>
      </div>
    </div>

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">mode</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">options</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">output_file</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">sources</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000153" class="method-detail">
        <a name="M000153"></a>

        <div class="method-heading">
          <a href="#M000153" class="method-signature">
          <span class="method-name">build</span><span class="method-args">(command, arguments)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Builds a logprocessor instance from the arguments given on the command line
<tt>command</tt> The command hat was used to start the log processor. This
can either be
</p>
<pre>
  :strip or :anonymize. This will set the processing mode.
</pre>
<p>
<tt>arguments</tt> The parsed command line arguments (a <a
href="../CommandLine/Arguments.html">CommandLine::Arguments</a> instance)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000153-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000153-source">
<pre>
    <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 27</span>
27:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">command</span>, <span class="ruby-identifier">arguments</span>)
28:       
29:       <span class="ruby-identifier">options</span> = { 
30:           <span class="ruby-identifier">:discard_teaser_lines</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">arguments</span>[<span class="ruby-identifier">:discard_teaser_lines</span>], 
31:           <span class="ruby-identifier">:keep_junk_lines</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">arguments</span>[<span class="ruby-identifier">:keep_junk_lines</span>], 
32:         }
33:           
34:       <span class="ruby-identifier">log_processor</span> = <span class="ruby-constant">RequestLogAnalyzer</span><span class="ruby-operator">::</span><span class="ruby-constant">LogProcessor</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">arguments</span>[<span class="ruby-identifier">:format</span>].<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">command</span>, <span class="ruby-identifier">options</span>)
35:       <span class="ruby-identifier">log_processor</span>.<span class="ruby-identifier">output_file</span> = <span class="ruby-identifier">arguments</span>[<span class="ruby-identifier">:output</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">arguments</span>[<span class="ruby-identifier">:output</span>]
36: 
37:       <span class="ruby-identifier">arguments</span>.<span class="ruby-identifier">parameters</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">input</span><span class="ruby-operator">|</span>
38:         <span class="ruby-identifier">log_processor</span>.<span class="ruby-identifier">sources</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">input</span>
39:       <span class="ruby-keyword kw">end</span>
40:       
41:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">log_processor</span>
42:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000154" class="method-detail">
        <a name="M000154"></a>

        <div class="method-heading">
          <a href="#M000154" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(format, mode, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Initializes a <a href="LogProcessor.html#M000154">new</a> <a
href="LogProcessor.html">LogProcessor</a> instance. <tt>format</tt> The
file format to use (e.g. :rails). <tt>mode</tt> The processing mode
(:anonymize or :strip) <tt>options</tt> A hash with options to take into
account
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000154-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000154-source">
<pre>
    <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 48</span>
48:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">format</span>, <span class="ruby-identifier">mode</span>, <span class="ruby-identifier">options</span> = {})
49:       <span class="ruby-ivar">@options</span> = <span class="ruby-identifier">options</span>
50:       <span class="ruby-ivar">@mode</span>    = <span class="ruby-identifier">mode</span>
51:       <span class="ruby-ivar">@sources</span> = []
52:       <span class="ruby-identifier">$output_file</span> = <span class="ruby-keyword kw">nil</span>
53:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">register_file_format</span>(<span class="ruby-identifier">format</span>)
54:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000158" class="method-detail">
        <a name="M000158"></a>

        <div class="method-heading">
          <a href="#M000158" class="method-signature">
          <span class="method-name">anonymize_line</span><span class="method-args">(line)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns an anonymized version of the provided line. This can be a copy of
the line it self, an empty string or a string in which some substrings are
substituted for anonymized values. <tt>line</tt> The line to anonymize
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000158-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000158-source">
<pre>
    <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 83</span>
83:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">anonymize_line</span>(<span class="ruby-identifier">line</span>)
84:       <span class="ruby-identifier">anonymized_line</span> = <span class="ruby-keyword kw">nil</span>
85:       <span class="ruby-identifier">file_format</span>.<span class="ruby-identifier">line_definitions</span>.<span class="ruby-identifier">detect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">definition</span><span class="ruby-operator">|</span> <span class="ruby-identifier">anonymized_line</span> = <span class="ruby-identifier">definition</span>.<span class="ruby-identifier">anonymize</span>(<span class="ruby-identifier">line</span>, <span class="ruby-identifier">options</span>) }
86:       
87:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">anonymized_line</span>
88:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">anonymized_line</span>
89:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:keep_junk_lines</span>]
90:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">line</span>
91:       <span class="ruby-keyword kw">else</span>
92:         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">&quot;&quot;</span>
93:       <span class="ruby-keyword kw">end</span>
94:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000155" class="method-detail">
        <a name="M000155"></a>

        <div class="method-heading">
          <a href="#M000155" class="method-signature">
          <span class="method-name">process_file</span><span class="method-args">(file)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Processes input files by opening it and sending the filestream to <tt><a
href="LogProcessor.html#M000156">process_io</a></tt>, in which the actual
processing is performed. <tt>file</tt> The file to process
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000155-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000155-source">
<pre>
    <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 59</span>
59:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_file</span>(<span class="ruby-identifier">file</span>)
60:       <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value str">'r'</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">process_io</span>(<span class="ruby-identifier">file</span>) }
61:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000156" class="method-detail">
        <a name="M000156"></a>

        <div class="method-heading">
          <a href="#M000156" class="method-signature">
          <span class="method-name">process_io</span><span class="method-args">(io)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Processes an input stream by iteration over each line and processing it
according to the current operation mode (:strip, :anonymize) <tt>io</tt>
The IO instance to process.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000156-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000156-source">
<pre>
    <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 66</span>
66:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_io</span>(<span class="ruby-identifier">io</span>)
67:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">mode</span>
68:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:strip</span>;     <span class="ruby-identifier">io</span>.<span class="ruby-identifier">each_line</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">strip_line</span>(<span class="ruby-identifier">line</span>) }
69:         <span class="ruby-keyword kw">when</span> <span class="ruby-identifier">:anonymize</span>; <span class="ruby-identifier">io</span>.<span class="ruby-identifier">each_line</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@output</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">anonymize_line</span>(<span class="ruby-identifier">line</span>) }
70:       <span class="ruby-keyword kw">end</span>
71:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000159" class="method-detail">
        <a name="M000159"></a>

        <div class="method-heading">
          <a href="#M000159" class="method-signature">
          <span class="method-name">run!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Runs the log processing by setting up the output stream and iterating over
all the input sources. Input sources can either be filenames (String
instances) or IO streams (IO instances). The strings &quot;-&quot; and
&quot;STDIN&quot; will be substituted for the $stdin variable.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000159-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000159-source">
<pre>
     <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 99</span>
 99:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run!</span>
100:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@output_file</span>.<span class="ruby-identifier">nil?</span>
101:         <span class="ruby-ivar">@output</span> = <span class="ruby-identifier">$stdout</span> 
102:       <span class="ruby-keyword kw">else</span>
103:         <span class="ruby-ivar">@output</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@output_file</span>, <span class="ruby-value str">'a'</span>)        
104:       <span class="ruby-keyword kw">end</span>
105:       
106:       <span class="ruby-ivar">@sources</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">source</span><span class="ruby-operator">|</span>
107:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">source</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">source</span>)
108:           <span class="ruby-identifier">process_file</span>(<span class="ruby-identifier">source</span>)
109:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">source</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">IO</span>)
110:           <span class="ruby-identifier">process_io</span>(<span class="ruby-identifier">source</span>)
111:         <span class="ruby-keyword kw">elsif</span> [<span class="ruby-value str">'-'</span>, <span class="ruby-value str">'STDIN'</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">source</span>)
112:           <span class="ruby-identifier">process_io</span>(<span class="ruby-identifier">$stdin</span>)        
113:         <span class="ruby-keyword kw">end</span>
114:       <span class="ruby-keyword kw">end</span>
115:     
116:     <span class="ruby-keyword kw">ensure</span>
117:       <span class="ruby-ivar">@output</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@output</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">File</span>)
118:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000157" class="method-detail">
        <a name="M000157"></a>

        <div class="method-heading">
          <a href="#M000157" class="method-signature">
          <span class="method-name">strip_line</span><span class="method-args">(line)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the line itself if the string matches any of the line definitions.
If no match is found, an empty line is returned, which will strip the line
from the output. <tt>line</tt> The line to strip
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000157-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000157-source">
<pre>
    <span class="ruby-comment cmt"># File lib/request_log_analyzer/log_processor.rb, line 76</span>
76:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">strip_line</span>(<span class="ruby-identifier">line</span>)
77:       <span class="ruby-identifier">file_format</span>.<span class="ruby-identifier">line_definitions</span>.<span class="ruby-identifier">any?</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">definition</span><span class="ruby-operator">|</span> <span class="ruby-identifier">definition</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">line</span> } <span class="ruby-operator">?</span> <span class="ruby-identifier">line</span> <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;&quot;</span>
78:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>